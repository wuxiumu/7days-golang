<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web文件管理器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#6366F1',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .file-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 1rem;
            }
            .file-card {
                @apply bg-white dark:bg-dark rounded-lg shadow-md hover:shadow-lg transition-all duration-300 p-3 border border-gray-100 dark:border-gray-700;
            }
            .file-card:hover {
                @apply transform -translate-y-1;
            }
            .breadcrumb-item {
                @apply text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-colors duration-200;
            }
            .btn {
                @apply px-4 py-2 rounded-md transition-all duration-200 font-medium;
            }
            .btn-primary {
                @apply bg-primary text-white hover:bg-primary/90 focus:ring-2 focus:ring-primary/50;
            }
            .btn-secondary {
                @apply bg-secondary text-white hover:bg-secondary/90 focus:ring-2 focus:ring-secondary/50;
            }
            .btn-outline {
                @apply border border-gray-300 dark:border-gray-600 bg-white dark:bg-dark text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800;
            }
            .input-field {
                @apply px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary dark:bg-gray-800 dark:text-white;
            }
            .modal-backdrop {
                @apply fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center transition-opacity duration-300;
            }
            .modal-content {
                @apply bg-white dark:bg-gray-900 rounded-lg shadow-xl w-full max-w-md mx-4 transform transition-all duration-300 scale-100;
            }
            .fade-in {
                @apply opacity-100;
            }
            .fade-out {
                @apply opacity-0 pointer-events-none;
            }
            .scale-in {
                @apply scale-100;
            }
            .scale-out {
                @apply scale-95 opacity-0;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen flex flex-col">
<!-- 顶部导航栏 -->
<header class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-30">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <i class="fa fa-folder-open text-primary text-2xl"></i>
            <h1 class="text-xl font-bold">Web文件管理器</h1>
        </div>

        <div class="flex items-center space-x-4">
            <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                <i class="fa fa-moon text-gray-600 dark:text-gray-300"></i>
            </button>
            <button id="upload-btn" class="btn btn-primary flex items-center">
                <i class="fa fa-upload mr-2"></i>上传文件
            </button>
        </div>
    </div>
</header>

<!-- 主内容区 -->
<main class="flex-grow container mx-auto px-4 py-6">
    <!-- 面包屑导航 -->
    <div class="mb-6 flex items-center space-x-2 text-sm">
        <button id="refresh-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
            <i class="fa fa-refresh text-gray-600 dark:text-gray-300"></i>
        </button>
        <div id="breadcrumb" class="flex items-center space-x-1">
            <a href="#" data-path="/" class="breadcrumb-item font-medium">根目录</a>
            <i class="fa fa-angle-right text-gray-400 text-xs"></i>
        </div>
    </div>

    <!-- 工具栏 -->
    <div class="mb-6 flex flex-wrap justify-between items-center gap-4">
        <div class="flex items-center space-x-3">
            <button id="new-folder-btn" class="btn btn-secondary flex items-center">
                <i class="fa fa-folder-plus mr-2"></i>新建文件夹
            </button>
            <div class="relative">
                <input type="text" id="search-input" placeholder="搜索文件..." class="input-field pl-10 w-64">
                <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>
        </div>

        <div class="flex items-center space-x-3">
            <span class="text-sm text-gray-500 dark:text-gray-400">视图:</span>
            <button id="grid-view-btn" class="p-2 rounded-md bg-primary/10 text-primary">
                <i class="fa fa-th-large"></i>
            </button>
            <button id="list-view-btn" class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                <i class="fa fa-list"></i>
            </button>
        </div>
    </div>

    <!-- 文件列表区域 -->
    <div id="file-container" class="file-grid">
        <!-- 文件和文件夹将通过JavaScript动态加载 -->
        <div class="col-span-full flex justify-center items-center py-16">
            <div class="text-center">
                <i class="fa fa-folder-open text-5xl text-gray-300 dark:text-gray-700 mb-4"></i>
                <p class="text-gray-500 dark:text-gray-400">加载中...</p>
            </div>
        </div>
    </div>
</main>

<!-- 页脚 -->
<footer class="bg-white dark:bg-gray-800 py-4 border-t border-gray-200 dark:border-gray-700">
    <div class="container mx-auto px-4 text-center text-sm text-gray-500 dark:text-gray-400">
        <p>© 2025 Web文件管理器 | 一个简单的文件管理工具</p>
    </div>
</footer>

<!-- 新建文件夹模态框 -->
<div id="new-folder-modal" class="modal-backdrop fade-out">
    <div class="modal-content scale-out">
        <div class="p-5 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold">新建文件夹</h3>
        </div>
        <div class="p-5">
            <div class="mb-4">
                <label for="folder-name" class="block text-sm font-medium mb-2">文件夹名称</label>
                <input type="text" id="folder-name" class="input-field w-full" placeholder="输入文件夹名称">
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancel-folder-btn" class="btn btn-outline">取消</button>
                <button id="confirm-folder-btn" class="btn btn-primary">创建</button>
            </div>
        </div>
    </div>
</div>

<!-- 文件上传模态框 -->
<div id="upload-modal" class="modal-backdrop fade-out">
    <div class="modal-content scale-out">
        <div class="p-5 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold">上传文件</h3>
        </div>
        <div class="p-5">
            <div class="mb-4">
                <div id="drop-area" class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center hover:border-primary transition-colors">
                    <i class="fa fa-cloud-upload text-4xl text-gray-400 dark:text-gray-600 mb-3"></i>
                    <p class="mb-2">拖放文件到这里，或</p>
                    <label class="btn btn-primary cursor-pointer">
                        选择文件
                        <input type="file" id="file-input" class="hidden" multiple>
                    </label>
                </div>
            </div>
            <div id="upload-progress-container" class="hidden mb-4">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-sm font-medium">上传进度</span>
                    <span id="upload-percentage" class="text-sm text-gray-500 dark:text-gray-400">0%</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                    <div id="upload-progress-bar" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancel-upload-btn" class="btn btn-outline">取消</button>
                <button id="start-upload-btn" class="btn btn-primary" disabled>开始上传</button>
            </div>
        </div>
    </div>
</div>

<!-- 文件查看模态框 -->
<div id="file-view-modal" class="modal-backdrop fade-out">
    <div class="modal-content max-w-4xl scale-out max-h-[90vh] flex flex-col">
        <div class="p-5 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
            <h3 id="file-view-title" class="text-lg font-semibold">文件内容</h3>
            <button id="close-file-view-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                <i class="fa fa-times text-gray-600 dark:text-gray-300"></i>
            </button>
        </div>
        <div id="file-view-content" class="p-5 overflow-auto max-h-[calc(90vh-120px)]">
            <!-- 文件内容将通过JavaScript动态加载 -->
        </div>
    </div>
</div>

<!-- 通知提示 -->
<div id="notification" class="fixed top-4 right-4 bg-white dark:bg-gray-800 shadow-lg rounded-lg p-4 max-w-sm transform translate-x-full transition-transform duration-300 flex items-start">
    <div id="notification-icon" class="mr-3 p-2 rounded-full bg-primary/10 text-primary">
        <i class="fa fa-info-circle"></i>
    </div>
    <div class="flex-grow">
        <h4 id="notification-title" class="font-medium">通知标题</h4>
        <p id="notification-message" class="text-sm text-gray-600 dark:text-gray-400 mt-1">通知内容将显示在这里...</p>
    </div>
    <button id="close-notification" class="ml-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
        <i class="fa fa-times"></i>
    </button>
</div>

<script>
    // 当前路径
    let currentPath = '/';
    // 选中的文件
    let selectedFiles = [];
    // 视图模式 (grid 或 list)
    let viewMode = 'grid';

    // DOM 加载完成后执行
    document.addEventListener('DOMContentLoaded', () => {
        // 加载文件列表
        loadFiles(currentPath);

        // 初始化事件监听
        initEventListeners();

        // 检查并应用主题
        applyTheme();
    });

    // 初始化事件监听
    function initEventListeners() {
        // 面包屑导航点击事件
        document.getElementById('breadcrumb').addEventListener('click', (e) => {
            if (e.target.tagName === 'A') {
                e.preventDefault();
                const path = e.target.dataset.path;
                navigateTo(path);
            }
        });

        // 刷新按钮点击事件
        document.getElementById('refresh-btn').addEventListener('click', () => {
            loadFiles(currentPath);
        });

        // 新建文件夹按钮点击事件
        document.getElementById('new-folder-btn').addEventListener('click', () => {
            openModal('new-folder-modal');
        });

        // 取消新建文件夹
        document.getElementById('cancel-folder-btn').addEventListener('click', () => {
            closeModal('new-folder-modal');
        });

        // 确认新建文件夹
        document.getElementById('confirm-folder-btn').addEventListener('click', createFolder);

        // 上传文件按钮点击事件
        document.getElementById('upload-btn').addEventListener('click', () => {
            openModal('upload-modal');
        });

        // 取消上传
        document.getElementById('cancel-upload-btn').addEventListener('click', () => {
            closeModal('upload-modal');
            resetUpload();
        });

        // 文件选择
        document.getElementById('file-input').addEventListener('change', handleFileSelect);

        // 拖放区域事件
        const dropArea = document.getElementById('drop-area');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropArea.classList.add('border-primary');
        }

        function unhighlight() {
            dropArea.classList.remove('border-primary');
        }

        dropArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        // 开始上传
        document.getElementById('start-upload-btn').addEventListener('click', uploadFiles);

        // 视图切换
        document.getElementById('grid-view-btn').addEventListener('click', () => {
            setViewMode('grid');
        });

        document.getElementById('list-view-btn').addEventListener('click', () => {
            setViewMode('list');
        });

        // 主题切换
        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

        // 关闭文件查看模态框
        document.getElementById('close-file-view-btn').addEventListener('click', () => {
            closeModal('file-view-modal');
        });

        // 关闭通知
        document.getElementById('close-notification').addEventListener('click', () => {
            hideNotification();
        });

        // 搜索文件
        document.getElementById('search-input').addEventListener('input', debounce(searchFiles, 300));
    }

    // 防抖函数
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                func.apply(this, args);
            }, wait);
        };
    }

    // 导航到指定路径
    function navigateTo(path) {
        currentPath = path;
        loadFiles(currentPath);
    }

    // 加载文件列表
    function loadFiles(path) {
        const fileContainer = document.getElementById('file-container');
        fileContainer.innerHTML = `
                <div class="col-span-full flex justify-center items-center py-16">
                    <div class="text-center">
                        <i class="fa fa-spinner fa-spin text-5xl text-primary mb-4"></i>
                        <p class="text-gray-500 dark:text-gray-400">加载中...</p>
                    </div>
                </div>
            `;

        fetch(`/api/list${path}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('无法获取文件列表');
                }
                return response.json();
            })
            .then(files => {
                updateBreadcrumb(path);
                renderFiles(files);
            })
            .catch(error => {
                showNotification('错误', error.message, 'error');
                fileContainer.innerHTML = `
                        <div class="col-span-full flex justify-center items-center py-16">
                            <div class="text-center">
                                <i class="fa fa-exclamation-triangle text-5xl text-red-500 mb-4"></i>
                                <p class="text-red-500">${error.message}</p>
                            </div>
                        </div>
                    `;
            });
    }

    // 更新面包屑导航
    function updateBreadcrumb(path) {
        const breadcrumb = document.getElementById('breadcrumb');
        breadcrumb.innerHTML = '';

        // 分割路径
        const parts = path.split('/').filter(part => part !== '');
        let currentPath = '';

        // 添加根目录
        addBreadcrumbItem('/', '根目录');

        // 添加子目录
        parts.forEach((part, index) => {
            currentPath += `/${part}`;
            const isLast = index === parts.length - 1;

            if (isLast) {
                // 最后一个项目不添加链接
                const span = document.createElement('span');
                span.className = 'text-gray-500 dark:text-gray-400 font-medium';
                span.textContent = part;
                breadcrumb.appendChild(span);
            } else {
                addBreadcrumbItem(currentPath, part);
            }

            if (!isLast) {
                // 添加分隔符
                const separator = document.createElement('i');
                separator.className = 'fa fa-angle-right text-gray-400 text-xs mx-1';
                breadcrumb.appendChild(separator);
            }
        });
    }

    // 添加面包屑项目
    function addBreadcrumbItem(path, text) {
        const link = document.createElement('a');
        link.href = '#';
        link.dataset.path = path;
        link.className = 'breadcrumb-item';
        link.textContent = text;
        document.getElementById('breadcrumb').appendChild(link);
    }

    // 渲染文件列表
    function renderFiles(files) {
        const fileContainer = document.getElementById('file-container');
        fileContainer.innerHTML = '';

        if (files.length === 0) {
            fileContainer.innerHTML = `
                    <div class="col-span-full flex justify-center items-center py-16">
                        <div class="text-center">
                            <i class="fa fa-folder-open text-5xl text-gray-300 dark:text-gray-700 mb-4"></i>
                            <p class="text-gray-500 dark:text-gray-400">此文件夹为空</p>
                        </div>
                    </div>
                `;
            return;
        }

        files.sort((a, b) => {
            if (a.isDir && !b.isDir) return -1;
            if (!a.isDir && b.isDir) return 1;

            // 添加空值检查
            if (!a.name && !b.name) return 0;
            if (!a.name) return 1;
            if (!b.name) return -1;

            return a.name.localeCompare(b.name);
        });

        if (viewMode === 'grid') {
            renderFilesAsGrid(files);
        } else {
            renderFilesAsList(files);
        }
    }

    // 以网格形式渲染文件列表
    function renderFilesAsGrid(files) {
        const fileContainer = document.getElementById('file-container');
        fileContainer.className = 'file-grid';

        files.forEach(file => {
            const fileCard = createFileCard(file);
            fileContainer.appendChild(fileCard);
        });
    }

    // 以列表形式渲染文件列表
    function renderFilesAsList(files) {
        const fileContainer = document.getElementById('file-container');
        fileContainer.className = '';

        const table = document.createElement('table');
        table.className = 'min-w-full divide-y divide-gray-200 dark:divide-gray-700';

        const thead = document.createElement('thead');
        thead.className = 'bg-gray-50 dark:bg-gray-800';
        thead.innerHTML = `
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">名称</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">大小</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">修改时间</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">操作</th>
                </tr>
            `;
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        tbody.className = 'bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700';

        files.forEach(file => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors';

            const icon = file.isDir ?
                '<i class="fa fa-folder text-yellow-500 mr-2"></i>' :
                '<i class="fa fa-file text-gray-400 mr-2"></i>';

            const size = file.isDir ? '-' : formatFileSize(file.size);
            const date = formatDateTime(file.modTime);

            tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            ${icon}
                            <span>${file.name}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${size}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <div class="flex space-x-2">
                            ${file.isDir ?
                `<button data-path="${file.path}" class="view-btn text-primary hover:text-primary/80 transition-colors">
                                    <i class="fa fa-folder-open"></i>
                                </button>` :
                `<button data-path="${file.path}" class="view-btn text-primary hover:text-primary/80 transition-colors">
                                    <i class="fa fa-eye"></i>
                                </button>`
            }
                            <button data-path="${file.path}" class="download-btn text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors">
                                <i class="fa fa-download"></i>
                            </button>
                            <button data-path="${file.path}" class="delete-btn text-red-500 hover:text-red-700 transition-colors">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;

            tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        fileContainer.appendChild(table);

        // 添加事件监听
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                var IsDir = e.target.classList.contains('fa-folder-open') ;
                const path = e.currentTarget.dataset.path;
                if (IsDir) {
                    navigateTo(path);
                } else {
                    viewFile(path);
                }
            });
        });

        document.querySelectorAll('.download-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const path = e.currentTarget.dataset.path;
                downloadFile(path);
            });
        });

        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const path = e.currentTarget.dataset.path;
                deleteFile(path);
            });
        });
    }

    // 创建文件卡片
    function createFileCard(file) {
        const card = document.createElement('div');
        card.className = 'file-card';
        card.dataset.path = file.path;

        const icon = file.isDir ?
            '<i class="fa fa-folder text-4xl text-yellow-500 mb-2"></i>' :
            '<i class="fa fa-file text-4xl text-gray-400 mb-2"></i>';

        const size = file.isDir ? '-' : formatFileSize(file.size);
        const date = formatDateTime(file.modTime);

        card.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center">
                    ${icon}
                    <h3 class="font-medium text-gray-800 dark:text-gray-200 truncate w-full mb-1">${file.name}</h3>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">${size}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">${date}</p>
                    <div class="mt-3 flex space-x-2 w-full">
                        ${file.isDir ?
            `<button class="flex-1 btn btn-outline text-xs py-1 view-btn">
                                <i class="fa fa-folder-open mr-1"></i>查看
                            </button>` :
            `<button class="flex-1 btn btn-outline text-xs py-1 view-btn">
                                <i class="fa fa-eye mr-1"></i>查看
                            </button>`
        }
                        <button class="flex-1 btn btn-outline text-xs py-1 download-btn">
                            <i class="fa fa-download mr-1"></i>下载
                        </button>
                    </div>
                    <button class="absolute top-2 right-2 text-gray-400 hover:text-red-500 transition-colors delete-btn">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            `;

        // 添加事件监听
        card.querySelector('.view-btn').addEventListener('click', () => {
            console.log(file)
            console.log(file.isDir)
            if (file.isDir) {
                navigateTo(file.path);
            } else {
                viewFile(file.path);
            }
        });

        card.querySelector('.download-btn').addEventListener('click', () => {
            downloadFile(file.path);
        });

        card.querySelector('.delete-btn').addEventListener('click', () => {
            deleteFile(file.path);
        });

        return card;
    }

    // 格式化文件大小
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';

        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));

        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // 格式化日期时间
    function formatDateTime(dateTime) {
        const date = new Date(dateTime);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');

        return `${year}-${month}-${day} ${hours}:${minutes}`;
    }

    // 设置视图模式
    function setViewMode(mode) {
        viewMode = mode;

        // 更新按钮状态
        document.getElementById('grid-view-btn').className = mode === 'grid' ?
            'p-2 rounded-md bg-primary/10 text-primary' :
            'p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors';

        document.getElementById('list-view-btn').className = mode === 'list' ?
            'p-2 rounded-md bg-primary/10 text-primary' :
            'p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors';

        // 重新加载文件
        loadFiles(currentPath);
    }

    // 新建文件夹
    function createFolder() {
        const folderName = document.getElementById('folder-name').value.trim();
        if (!folderName) {
            showNotification('错误', '请输入文件夹名称', 'error');
            return;
        }

        const folderPath = currentPath === '/' ?
            `/${folderName}` :
            `${currentPath}/${folderName}`;

        fetch(`/api/mkdir${folderPath}`, {
            method: 'POST'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('创建文件夹失败');
                }
                return response.text();
            })
            .then(message => {
                showNotification('成功', message, 'success');
                closeModal('new-folder-modal');
                document.getElementById('folder-name').value = '';
                loadFiles(currentPath);
            })
            .catch(error => {
                showNotification('错误', error.message, 'error');
            });
    }

    // 处理文件选择
    function handleFileSelect(e) {
        const files = e.target.files;
        handleFiles(files);
    }

    // 处理文件
    function handleFiles(files) {
        if (files.length > 0) {
            document.getElementById('start-upload-btn').disabled = false;
            document.getElementById('upload-progress-container').classList.remove('hidden');
            document.getElementById('upload-percentage').textContent = '0%';
            document.getElementById('upload-progress-bar').style.width = '0%';
        } else {
            document.getElementById('start-upload-btn').disabled = true;
            document.getElementById('upload-progress-container').classList.add('hidden');
        }
    }

    // 上传文件
    function uploadFiles() {
        const fileInput = document.getElementById('file-input');
        const files = fileInput.files;

        if (files.length === 0) {
            showNotification('错误', '请选择要上传的文件', 'error');
            return;
        }

        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('file', files[i]);
        }
        formData.append('path', currentPath);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/upload/', true);

        xhr.upload.onprogress = function(e) {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                document.getElementById('upload-percentage').textContent = `${Math.round(percentComplete)}%`;
                document.getElementById('upload-progress-bar').style.width = `${percentComplete}%`;
            }
        };

        xhr.onload = function() {
            if (xhr.status === 201) {
                showNotification('成功', '文件上传成功', 'success');
                closeModal('upload-modal');
                resetUpload();
                loadFiles(currentPath);
            } else {
                showNotification('错误', `上传失败: ${xhr.statusText}`, 'error');
            }
        };

        xhr.onerror = function() {
            showNotification('错误', '上传过程中发生错误', 'error');
        };

        xhr.send(formData);
    }

    // 重置上传状态
    function resetUpload() {
        document.getElementById('file-input').value = '';
        document.getElementById('start-upload-btn').disabled = true;
        document.getElementById('upload-progress-container').classList.add('hidden');
        document.getElementById('upload-percentage').textContent = '0%';
        document.getElementById('upload-progress-bar').style.width = '0%';
    }

    // 查看文件
    function viewFile(path) {
        console.log(path);
        if (!path) {
            showNotification('错误', '无效的文件路径', 'error');
            return;
        }

        const fileViewTitle = document.getElementById('file-view-title');
        const fileViewContent = document.getElementById('file-view-content');

        // 使用可选链和空值合并操作符确保安全
        fileViewTitle.textContent = `查看: ${path.split('/').pop() || '未知文件'}`;


        fileViewContent.innerHTML = `
                <div class="flex justify-center items-center py-8">
                    <div class="text-center">
                        <i class="fa fa-spinner fa-spin text-3xl text-primary mb-2"></i>

                        <p class="text-gray-500 dark:text-gray-400">加载中...</p>
                    </div>
                </div>
            `;

        fetch(`/view${path}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('无法获取文件内容');
                }

                const contentType = response.headers.get('content-type');

                if (contentType.startsWith('text/') ||
                    contentType.includes('json') ||
                    contentType.includes('xml')) {
                    return response.text().then(text => {
                        const pre = document.createElement('pre');
                        pre.className = 'bg-gray-800 text-gray-200 p-4 rounded-lg overflow-auto max-h-[calc(90vh-200px)] font-mono text-sm';
                        pre.textContent = text;
                        fileViewContent.innerHTML = '';
                        fileViewContent.appendChild(pre);

                        // 如果是代码类型，尝试美化
                        if (contentType.includes('javascript') ||
                            contentType.includes('json') ||
                            contentType.includes('html') ||
                            contentType.includes('css') ||
                            contentType.includes('xml')) {
                            try {
                                // 简单的语法高亮
                                const code = document.createElement('code');
                                code.className = 'language-' + (contentType.includes('json') ? 'json' :
                                    contentType.includes('javascript') ? 'javascript' :
                                        contentType.includes('html') ? 'html' :
                                            contentType.includes('css') ? 'css' : 'xml');
                                code.textContent = text;
                                pre.innerHTML = '';
                                pre.appendChild(code);

                                // 这里可以添加更复杂的语法高亮
                            } catch (e) {
                                // 忽略错误，使用普通文本
                            }
                        }
                    });
                } else if (contentType.startsWith('image/')) {
                    return response.blob().then(blob => {
                        const img = document.createElement('img');
                        img.src = URL.createObjectURL(blob);
                        img.className = 'max-w-full max-h-[calc(90vh-200px)] object-contain';
                        fileViewContent.innerHTML = '';
                        fileViewContent.appendChild(img);
                    });
                } else {
                    throw new Error('不支持的文件类型');
                }
            })
            .catch(error => {
                fileViewContent.innerHTML = `
                        <div class="flex justify-center items-center py-8">
                            <div class="text-center">
                                <i class="fa fa-exclamation-triangle text-3xl text-red-500 mb-2"></i>
                                <p class="text-red-500">${error.message}</p>
                            </div>
                        </div>
                    `;
            });

        openModal('file-view-modal');
    }

    // 下载文件
    function downloadFile(path) {
        const link = document.createElement('a');
        link.href = `/download${path}`;
        link.download = path.split('/').pop();
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // 删除文件
    function deleteFile(path) {
        if (!confirm('确定要删除此文件/文件夹吗？此操作不可撤销！')) {
            return;
        }

        fetch(`/api/delete${path}`, {
            method: 'DELETE'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('删除失败');
                }
                return response.text();
            })
            .then(message => {
                showNotification('成功', message, 'success');
                loadFiles(currentPath);
            })
            .catch(error => {
                showNotification('错误', error.message, 'error');
            });
    }

    // 搜索文件
    function searchFiles() {
        const searchTerm = document.getElementById('search-input').value.trim().toLowerCase();

        if (!searchTerm) {
            // 如果搜索框为空，重新加载完整列表
            loadFiles(currentPath);
            return;
        }

        fetch(`/api/list${currentPath}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('无法获取文件列表');
                }
                return response.json();
            })
            .then(files => {
                // 过滤文件列表
                const filteredFiles = files.filter(file =>
                    file.Name.toLowerCase().includes(searchTerm)
                );

                updateBreadcrumb(currentPath);
                renderFiles(filteredFiles);
            })
            .catch(error => {
                showNotification('错误', error.message, 'error');
            });
    }

    // 打开模态框
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.classList.remove('fade-out');
        modal.classList.add('fade-in');

        const modalContent = modal.querySelector('.modal-content');
        modalContent.classList.remove('scale-out');
        modalContent.classList.add('scale-in');

        // 阻止背景滚动
        document.body.style.overflow = 'hidden';
    }

    // 关闭模态框
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.classList.remove('fade-in');
        modal.classList.add('fade-out');

        const modalContent = modal.querySelector('.modal-content');
        modalContent.classList.remove('scale-in');
        modalContent.classList.add('scale-out');

        // 恢复背景滚动
        document.body.style.overflow = '';
    }

    // 显示通知
    function showNotification(title, message, type = 'info') {
        const notification = document.getElementById('notification');
        const notificationTitle = document.getElementById('notification-title');
        const notificationMessage = document.getElementById('notification-message');
        const notificationIcon = document.getElementById('notification-icon');

        notificationTitle.textContent = title;
        notificationMessage.textContent = message;

        // 设置图标和颜色
        notificationIcon.className = 'mr-3 p-2 rounded-full';
        if (type === 'success') {
            notificationIcon.className += ' bg-green-100 text-green-600 dark:bg-green-900 dark:text-green-400';
            notificationIcon.innerHTML = '<i class="fa fa-check-circle"></i>';
        } else if (type === 'error') {
            notificationIcon.className += ' bg-red-100 text-red-600 dark:bg-red-900 dark:text-red-400';
            notificationIcon.innerHTML = '<i class="fa fa-exclamation-circle"></i>';
        } else if (type === 'warning') {
            notificationIcon.className += ' bg-yellow-100 text-yellow-600 dark:bg-yellow-900 dark:text-yellow-400';
            notificationIcon.innerHTML = '<i class="fa fa-exclamation-triangle"></i>';
        } else {
            notificationIcon.className += ' bg-blue-100 text-blue-600 dark:bg-blue-900 dark:text-blue-400';
            notificationIcon.innerHTML = '<i class="fa fa-info-circle"></i>';
        }

        // 显示通知
        notification.classList.remove('translate-x-full');
        notification.classList.add('translate-x-0');

        // 3秒后自动隐藏
        setTimeout(hideNotification, 3000);
    }

    // 隐藏通知
    function hideNotification() {
        const notification = document.getElementById('notification');
        notification.classList.remove('translate-x-0');
        notification.classList.add('translate-x-full');
    }

    // 切换主题
    function toggleTheme() {
        const isDarkMode = document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');

        // 更新主题图标
        const themeToggle = document.getElementById('theme-toggle');
        themeToggle.innerHTML = isDarkMode ?
            '<i class="fa fa-sun text-yellow-400"></i>' :
            '<i class="fa fa-moon text-gray-600 dark:text-gray-300"></i>';
    }

    // 应用主题
    function applyTheme() {
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
            document.documentElement.classList.add('dark');
            document.getElementById('theme-toggle').innerHTML = '<i class="fa fa-sun text-yellow-400"></i>';
        } else {
            document.documentElement.classList.remove('dark');
            document.getElementById('theme-toggle').innerHTML = '<i class="fa fa-moon text-gray-600 dark:text-gray-300"></i>';
        }
    }
</script>
</body>
</html>